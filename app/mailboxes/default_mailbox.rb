class DefaultMailbox < ApplicationMailbox
  include MailboxHelper

  attr_accessor :channel, :account, :inbox, :conversation, :processed_mail

  before_processing :find_channel,
                    :load_account,
                    :load_inbox,
                    :decorate_mail

  # put semicolon after process like this def process; , when you remove the puts line and the function in empty
  def process
    puts "default_mailbox file inside process function, mail.inspect: #{mail.inspect}, @channel.inspect: #{@channel.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"
    Rails.logger.info "Processing email #{mail.message_id} from #{original_sender_email} to #{mail.to} with subject #{mail.subject} , inspecting mail: #{mail.inspect}######################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################"
    puts "default_mailbox file inside process function - @account.inspect: #{@account.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    # to turn off spam conversation creation
    return unless @account.active?
    # prevent loop from chatwoot notification emails
    return if notification_email_from_chatwoot?

    # return if email doesn't have a valid sender
    # This can happen in cases like bounce emails for invalid contact email address
    # TODO: Handle the bounce seperately and mark the contact as invalid
    # we are checking for @ since the returned value could be "\"\"" for some email clients
    return unless original_sender_email.include?('@')

    ActiveRecord::Base.transaction do
      find_or_create_contact
      find_or_create_conversation
      create_message
      add_attachments_to_message
    end
  end

  private

  def find_channel
    puts "default_mailbox file inside find_channel function - @channel.inspect: #{@channel.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    find_channel_with_to_mail if @channel.blank?

    raise 'Email channel/inbox not found' if @channel.nil?

    @channel
  end

  def find_channel_with_to_mail
    # Extract the domain from the "To" field
    to_address = mail.to&.first
    domain = to_address&.split('@')&.last
    puts "default_mailbox file, in find_channel_with_to_mail function, domain: #{domain}##################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################"
    # # Find the channel based on the domain
    # channel = Channel::Email.find_by('lower(email) = ? OR lower(forward_to_email) = ?', domain, domain)

    # if channel.nil?
    #   # If channel is not found, handle it accordingly (raise error, log, etc.)
    #   raise "Email channel not found for domain: #{domain}"
    # end

    # puts "default_mailbox file inside find_channel_with_to_mail function - channel.inspect: #{channel.inspect}, mail.inspect: #{mail.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @channel = EmailChannelFinder.new(mail).perform
  end

  def load_account
    puts "default_mailbox file inside load_account function - @channel.inspect: #{@channel.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @account = @channel.account
  end

  def load_inbox
    puts "default_mailbox file inside load_inbox function - @channel.inspect: #{@channel.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @inbox = @channel.inbox
  end

  def decorate_mail
    puts "default_mailbox file inside decorate_mail function - @account.inspect: #{@account.inspect}, mail.inspect: #{mail.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @processed_mail = MailPresenter.new(mail, @account)
    puts "default_mailbox file inside decorate_mail function - @processed_mail.inspect: #{@processed_mail.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"
  end

  def find_conversation_by_in_reply_to
    puts "default_mailbox file inside find_conversation_by_in_reply_to function - @account.inspect: #{@account.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    return if in_reply_to.blank?

    @account.conversations.where("additional_attributes->>'in_reply_to' = ?", in_reply_to).first
  end

  def in_reply_to
    puts "default_mailbox file inside find_conversation_by_in_reply_to function - mail['In-Reply-To']: #{mail['In-Reply-To']}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    mail['In-Reply-To'].try(:value)
  end

  def original_sender_email
    puts "default_mailbox file inside original_sender_email function - @processed_mail.inspect: #{@processed_mail.inspect}, @processed_mail.original_sender&.downcase: #{@processed_mail.original_sender&.downcase}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @processed_mail.original_sender&.downcase
  end

  def find_or_create_conversation
    @conversation = find_conversation_by_in_reply_to || ::Conversation.create!({
                                                                                 account_id: @account.id,
                                                                                 inbox_id: @inbox.id,
                                                                                 contact_id: @contact.id,
                                                                                 contact_inbox_id: @contact_inbox.id,
                                                                                 additional_attributes: {
                                                                                   in_reply_to: in_reply_to,
                                                                                   source: 'email',
                                                                                   mail_subject: @processed_mail.subject,
                                                                                   initiated_at: {
                                                                                     timestamp: Time.now.utc
                                                                                   }
                                                                                 }
                                                                               })
    puts "default_mailbox file inside find_or_create_conversation function - @processed_mail.inspect: #{@processed_mail.inspect}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"
  end

  def find_or_create_contact
    puts "default_mailbox file inside find_or_create_contact function - original_sender_email: #{original_sender_email}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    @contact = @inbox.contacts.from_email(original_sender_email)
    if @contact.present?
      @contact_inbox = ContactInbox.find_by(inbox: @inbox, contact: @contact)
    else
      create_contact
    end
  end

  def identify_contact_name
    puts "default_mailbox file inside identify_contact_name function - processed_mail: #{processed_mail}#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################v"

    processed_mail.sender_name || processed_mail.from.first.split('@').first
  end
end
